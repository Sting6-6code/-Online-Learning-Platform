<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Subscription.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Online Learning Platform</a> &gt; <a href="index.source.html" class="el_package">com.olp.model.payment</a> &gt; <span class="el_source">Subscription.java</span></div><h1>Subscription.java</h1><pre class="source lang-java linenums">/*PLEASE DO NOT EDIT THIS CODE*/
/*This code was generated using the UMPLE 1.35.0.7523.c616a4dce modeling language!*/


package com.olp.model.payment;

import java.sql.Date;
import java.util.*;
import javax.persistence.*;
import com.olp.util.Utils;

/**
 * ===== ????????? =====
 * Task 0.7: 添加 JPA 注解
 */
// line 176 &quot;model.ump&quot;
// line 285 &quot;model.ump&quot;
@Entity
@Table(name = &quot;subscriptions&quot;)
public class Subscription
{

  //------------------------
  // ENUMERATIONS
  //------------------------
  // Note: PaymentStatus is defined in Payment class
<span class="fc" id="L27">  public enum PlanType { Trial, Monthly, Annual }</span>

  //------------------------
  // MEMBER VARIABLES
  //------------------------

  //Subscription Attributes
  @Id
  @Column(name = &quot;id&quot;, length = 50)
  private String id;
  
  @Enumerated(EnumType.STRING)
  @Column(name = &quot;plan&quot;, length = 20, nullable = false)
  private PlanType plan;
  
  @Column(name = &quot;start_at&quot;, nullable = false)
  private Date startAt;
  
  @Column(name = &quot;next_billing_at&quot;, nullable = false)
  private Date nextBillingAt;

  //Subscription State Machines
<span class="fc" id="L49">  public enum Status { Trial, Active, PastDue, Suspended, Cancelled }</span>
  
  @Enumerated(EnumType.STRING)
  @Column(name = &quot;status&quot;, length = 20, nullable = false)
  private Status status;

  //Subscription Associations
  @OneToMany(mappedBy = &quot;subscription&quot;, cascade = CascadeType.ALL, orphanRemoval = true)
  private List&lt;com.olp.model.payment.Payment&gt; subscriptionPayments;

  //------------------------
  // CONSTRUCTOR
  //------------------------

  /**
   * Protected no-argument constructor for JPA
   */
  protected Subscription()
<span class="nc" id="L67">  {</span>
<span class="nc" id="L68">    subscriptionPayments = new ArrayList&lt;Payment&gt;();</span>
<span class="nc" id="L69">    status = Status.Trial;</span>
<span class="nc" id="L70">  }</span>

  /**
   * Task 4.1: 添加构造函数验证
   */
  public Subscription(String aId, PlanType aPlan, Date aStartAt, Date aNextBillingAt)
<span class="fc" id="L76">  {</span>
    // Task 4.1: 验证 plan 不为 null
<span class="fc bfc" id="L78" title="All 2 branches covered.">    if (aPlan == null) {</span>
<span class="fc" id="L79">      throw new IllegalArgumentException(&quot;Subscription plan cannot be null&quot;);</span>
    }
    
    // Task 4.1: 验证 startAt 不为 null
<span class="fc bfc" id="L83" title="All 2 branches covered.">    if (aStartAt == null) {</span>
<span class="fc" id="L84">      throw new IllegalArgumentException(&quot;Subscription startAt cannot be null&quot;);</span>
    }
    
    // Task 4.1: nextBillingAt 可以为 null（初始创建时）
    
<span class="fc" id="L89">    id = aId;</span>
<span class="fc" id="L90">    plan = aPlan;</span>
<span class="fc" id="L91">    startAt = aStartAt;</span>
<span class="fc" id="L92">    nextBillingAt = aNextBillingAt;</span>
<span class="fc" id="L93">    subscriptionPayments = new ArrayList&lt;com.olp.model.payment.Payment&gt;();</span>
<span class="fc" id="L94">    setStatus(Status.Trial);</span>
<span class="fc" id="L95">  }</span>

  //------------------------
  // INTERFACE
  //------------------------

  public boolean setId(String aId)
  {
<span class="nc" id="L103">    boolean wasSet = false;</span>
<span class="nc" id="L104">    id = aId;</span>
<span class="nc" id="L105">    wasSet = true;</span>
<span class="nc" id="L106">    return wasSet;</span>
  }

  public boolean setPlan(PlanType aPlan)
  {
<span class="nc" id="L111">    boolean wasSet = false;</span>
<span class="nc" id="L112">    plan = aPlan;</span>
<span class="nc" id="L113">    wasSet = true;</span>
<span class="nc" id="L114">    return wasSet;</span>
  }

  public boolean setStartAt(Date aStartAt)
  {
<span class="nc" id="L119">    boolean wasSet = false;</span>
<span class="nc" id="L120">    startAt = aStartAt;</span>
<span class="nc" id="L121">    wasSet = true;</span>
<span class="nc" id="L122">    return wasSet;</span>
  }

  public boolean setNextBillingAt(Date aNextBillingAt)
  {
<span class="fc" id="L127">    boolean wasSet = false;</span>
<span class="fc" id="L128">    nextBillingAt = aNextBillingAt;</span>
<span class="fc" id="L129">    wasSet = true;</span>
<span class="fc" id="L130">    return wasSet;</span>
  }

  public String getId()
  {
<span class="fc" id="L135">    return id;</span>
  }

  public PlanType getPlan()
  {
<span class="fc" id="L140">    return plan;</span>
  }

  public Date getStartAt()
  {
<span class="fc" id="L145">    return startAt;</span>
  }

  public Date getNextBillingAt()
  {
<span class="fc" id="L150">    return nextBillingAt;</span>
  }

  public String getStatusFullName()
  {
<span class="nc" id="L155">    String answer = status.toString();</span>
<span class="nc" id="L156">    return answer;</span>
  }

  public Status getStatus()
  {
<span class="fc" id="L161">    return status;</span>
  }

  /**
   * Task 4.2: 实现 chargeSuccess() 方法
   * 计费成功：从 Trial/Active/PastDue 状态转换到 Active 状态
   */
  public boolean chargeSuccess()
  {
    // 守卫条件：当前状态必须是 Trial、Active 或 PastDue
<span class="pc bpc" id="L171" title="3 of 6 branches missed.">    if (status != Status.Trial &amp;&amp; status != Status.Active &amp;&amp; status != Status.PastDue) {</span>
<span class="nc" id="L172">      return false;</span>
    }
    
    // 守卫条件：最近一笔 Payment 状态为 Succeeded
<span class="fc" id="L176">    Payment latestPayment = getLatestPayment();</span>
<span class="fc bfc" id="L177" title="All 4 branches covered.">    if (latestPayment == null || latestPayment.getStatus() != Payment.PaymentStatus.Succeeded) {</span>
<span class="fc" id="L178">      return false;</span>
    }
    
    // 状态转换
<span class="fc" id="L182">    setStatus(Status.Active);</span>
    
    // 更新 nextBillingAt
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">    if (nextBillingAt != null) {</span>
<span class="fc bfc" id="L186" title="All 2 branches covered.">      if (plan == PlanType.Monthly) {</span>
<span class="fc" id="L187">        nextBillingAt = Utils.addMonths(nextBillingAt, 1);</span>
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">      } else if (plan == PlanType.Annual) {</span>
<span class="fc" id="L189">        nextBillingAt = Utils.addMonths(nextBillingAt, 12);</span>
      }
      // Trial 计划不更新 nextBillingAt
    }
    
<span class="fc" id="L194">    return true;</span>
  }
  
  /**
   * Task 4.2: 获取最近一笔 Payment
   */
  private Payment getLatestPayment() {
<span class="pc bpc" id="L201" title="1 of 4 branches missed.">    if (subscriptionPayments == null || subscriptionPayments.isEmpty()) {</span>
<span class="fc" id="L202">      return null;</span>
    }
    // 找到最近的一笔 Payment（按 paidAt 排序，取最新的）
<span class="fc" id="L205">    Payment latest = null;</span>
<span class="fc" id="L206">    Date latestDate = null;</span>
<span class="fc bfc" id="L207" title="All 2 branches covered.">    for (Payment payment : subscriptionPayments) {</span>
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">      if (payment.getPaidAt() != null) {</span>
<span class="pc bpc" id="L209" title="1 of 4 branches missed.">        if (latestDate == null || Utils.compareDates(payment.getPaidAt(), latestDate) &gt; 0) {</span>
<span class="fc" id="L210">          latest = payment;</span>
<span class="fc" id="L211">          latestDate = payment.getPaidAt();</span>
        }
      }
<span class="fc" id="L214">    }</span>
<span class="fc" id="L215">    return latest;</span>
  }

  /**
   * Task 4.3: 实现 chargeFail() 方法
   * 计费失败：从 Active 状态转换到 PastDue 状态
   */
  public boolean chargeFail()
  {
    // 守卫条件：当前状态必须是 Active
<span class="fc bfc" id="L225" title="All 2 branches covered.">    if (status != Status.Active) {</span>
<span class="fc" id="L226">      return false;</span>
    }
    
    // 守卫条件：最近一笔 Payment 状态为 Failed
<span class="fc" id="L230">    Payment latestPayment = getLatestPayment();</span>
<span class="pc bpc" id="L231" title="1 of 4 branches missed.">    if (latestPayment == null || latestPayment.getStatus() != Payment.PaymentStatus.Failed) {</span>
<span class="fc" id="L232">      return false;</span>
    }
    
    // 状态转换
<span class="fc" id="L236">    setStatus(Status.PastDue);</span>
<span class="fc" id="L237">    return true;</span>
  }

  /**
   * Task 4.4: 实现 cancel() 方法
   * 取消订阅：从任意状态转换到 Cancelled 状态
   */
  public boolean cancel()
  {
    // 可以从任意状态取消（无守卫条件）
    // 状态转换
<span class="fc" id="L248">    setStatus(Status.Cancelled);</span>
<span class="fc" id="L249">    return true;</span>
  }

  /**
   * Task 4.5: 实现 graceExpire() 方法
   * 宽限期到期：从 PastDue 状态转换到 Suspended 状态
   */
  public boolean graceExpire()
  {
    // 守卫条件：当前状态必须是 PastDue
<span class="fc bfc" id="L259" title="All 2 branches covered.">    if (status != Status.PastDue) {</span>
<span class="fc" id="L260">      return false;</span>
    }
    
    // 守卫条件：当前日期 &gt; 宽限到期（宽限期为 7 天）
<span class="pc bpc" id="L264" title="1 of 2 branches missed.">    if (nextBillingAt == null) {</span>
<span class="nc" id="L265">      return false;</span>
    }
<span class="fc" id="L267">    Date graceExpiryDate = Utils.addDays(nextBillingAt, 7);</span>
<span class="fc" id="L268">    Date currentTime = Utils.getCurrentTime();</span>
<span class="fc bfc" id="L269" title="All 2 branches covered.">    if (Utils.compareDates(currentTime, graceExpiryDate) &lt;= 0) {</span>
<span class="fc" id="L270">      return false; // 宽限期未到期</span>
    }
    
    // 状态转换
<span class="fc" id="L274">    setStatus(Status.Suspended);</span>
<span class="fc" id="L275">    return true;</span>
  }

  private void setStatus(Status aStatus)
  {
<span class="fc" id="L280">    status = aStatus;</span>
<span class="fc" id="L281">  }</span>
  /* Code from template association_GetMany */
  public com.olp.model.payment.Payment getSubscriptionPayment(int index)
  {
<span class="fc" id="L285">    com.olp.model.payment.Payment aSubscriptionPayment = subscriptionPayments.get(index);</span>
<span class="fc" id="L286">    return aSubscriptionPayment;</span>
  }

  public List&lt;com.olp.model.payment.Payment&gt; getSubscriptionPayments()
  {
<span class="nc" id="L291">    List&lt;com.olp.model.payment.Payment&gt; newSubscriptionPayments = Collections.unmodifiableList(subscriptionPayments);</span>
<span class="nc" id="L292">    return newSubscriptionPayments;</span>
  }

  public int numberOfSubscriptionPayments()
  {
<span class="fc" id="L297">    int number = subscriptionPayments.size();</span>
<span class="fc" id="L298">    return number;</span>
  }

  public boolean hasSubscriptionPayments()
  {
<span class="pc bpc" id="L303" title="1 of 2 branches missed.">    boolean has = subscriptionPayments.size() &gt; 0;</span>
<span class="fc" id="L304">    return has;</span>
  }

  public int indexOfSubscriptionPayment(com.olp.model.payment.Payment aSubscriptionPayment)
  {
<span class="nc" id="L309">    int index = subscriptionPayments.indexOf(aSubscriptionPayment);</span>
<span class="nc" id="L310">    return index;</span>
  }
  /* Code from template association_MinimumNumberOfMethod */
  public static int minimumNumberOfSubscriptionPayments()
  {
<span class="nc" id="L315">    return 0;</span>
  }
  /* Code from template association_AddManyToOne */
  public com.olp.model.payment.Payment addSubscriptionPayment(String aId, double aAmount, Payment.PaymentStatus aStatus, Date aPaidAt)
  {
<span class="nc" id="L320">    return new com.olp.model.payment.Payment(aId, aAmount, aStatus, aPaidAt, this);</span>
  }

  public boolean addSubscriptionPayment(com.olp.model.payment.Payment aSubscriptionPayment)
  {
<span class="fc" id="L325">    boolean wasAdded = false;</span>
<span class="pc bpc" id="L326" title="1 of 2 branches missed.">    if (subscriptionPayments.contains(aSubscriptionPayment)) { return false; }</span>
<span class="fc" id="L327">    Subscription existingSubscription = aSubscriptionPayment.getSubscription();</span>
<span class="pc bpc" id="L328" title="2 of 4 branches missed.">    boolean isNewSubscription = existingSubscription != null &amp;&amp; !this.equals(existingSubscription);</span>
<span class="pc bpc" id="L329" title="1 of 2 branches missed.">    if (isNewSubscription)</span>
    {
<span class="nc" id="L331">      aSubscriptionPayment.setSubscription(this);</span>
    }
    else
    {
<span class="fc" id="L335">      subscriptionPayments.add(aSubscriptionPayment);</span>
    }
<span class="fc" id="L337">    wasAdded = true;</span>
<span class="fc" id="L338">    return wasAdded;</span>
  }

  public boolean removeSubscriptionPayment(com.olp.model.payment.Payment aSubscriptionPayment)
  {
<span class="nc" id="L343">    boolean wasRemoved = false;</span>
    //Unable to remove aSubscriptionPayment, as it must always have a subscription
<span class="nc bnc" id="L345" title="All 2 branches missed.">    if (!this.equals(aSubscriptionPayment.getSubscription()))</span>
    {
<span class="nc" id="L347">      subscriptionPayments.remove(aSubscriptionPayment);</span>
<span class="nc" id="L348">      wasRemoved = true;</span>
    }
<span class="nc" id="L350">    return wasRemoved;</span>
  }
  /* Code from template association_AddIndexControlFunctions */
  public boolean addSubscriptionPaymentAt(com.olp.model.payment.Payment aSubscriptionPayment, int index)
  {  
<span class="nc" id="L355">    boolean wasAdded = false;</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">    if(addSubscriptionPayment(aSubscriptionPayment))</span>
    {
<span class="nc bnc" id="L358" title="All 2 branches missed.">      if(index &lt; 0 ) { index = 0; }</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">      if(index &gt; numberOfSubscriptionPayments()) { index = numberOfSubscriptionPayments() - 1; }</span>
<span class="nc" id="L360">      subscriptionPayments.remove(aSubscriptionPayment);</span>
<span class="nc" id="L361">      subscriptionPayments.add(index, aSubscriptionPayment);</span>
<span class="nc" id="L362">      wasAdded = true;</span>
    }
<span class="nc" id="L364">    return wasAdded;</span>
  }

  public boolean addOrMoveSubscriptionPaymentAt(com.olp.model.payment.Payment aSubscriptionPayment, int index)
  {
<span class="nc" id="L369">    boolean wasAdded = false;</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">    if(subscriptionPayments.contains(aSubscriptionPayment))</span>
    {
<span class="nc bnc" id="L372" title="All 2 branches missed.">      if(index &lt; 0 ) { index = 0; }</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">      if(index &gt; numberOfSubscriptionPayments()) { index = numberOfSubscriptionPayments() - 1; }</span>
<span class="nc" id="L374">      subscriptionPayments.remove(aSubscriptionPayment);</span>
<span class="nc" id="L375">      subscriptionPayments.add(index, aSubscriptionPayment);</span>
<span class="nc" id="L376">      wasAdded = true;</span>
    } 
    else 
    {
<span class="nc" id="L380">      wasAdded = addSubscriptionPaymentAt(aSubscriptionPayment, index);</span>
    }
<span class="nc" id="L382">    return wasAdded;</span>
  }

  /**
   * Task 5.10: 实现 SubscriptionBillingConsistency 约束验证
   * OCL 约束：Active 状态的订阅，nextBillingAt 必须大于 startAt
   * @return true 如果计费时间一致，否则返回 false
   */
  public boolean validateBillingConsistency() {
<span class="nc bnc" id="L391" title="All 6 branches missed.">    if (status == Status.Active &amp;&amp; nextBillingAt != null &amp;&amp; startAt != null) {</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">      return Utils.compareDates(nextBillingAt, startAt) &gt; 0;</span>
    }
<span class="nc" id="L394">    return true; // 非 Active 状态或时间为 null 时不检查</span>
  }

  public void delete()
  {
<span class="nc bnc" id="L399" title="All 2 branches missed.">    for(int i=subscriptionPayments.size(); i &gt; 0; i--)</span>
    {
<span class="nc" id="L401">      com.olp.model.payment.Payment aSubscriptionPayment = subscriptionPayments.get(i - 1);</span>
<span class="nc" id="L402">      aSubscriptionPayment.delete();</span>
    }
<span class="nc" id="L404">  }</span>


  public String toString()
  {
<span class="nc" id="L409">    return super.toString() + &quot;[&quot;+</span>
<span class="nc" id="L410">            &quot;id&quot; + &quot;:&quot; + getId()+ &quot;]&quot; + System.getProperties().getProperty(&quot;line.separator&quot;) +</span>
<span class="nc bnc" id="L411" title="All 4 branches missed.">            &quot;  &quot; + &quot;plan&quot; + &quot;=&quot; + (getPlan() != null ? !getPlan().equals(this)  ? getPlan().toString().replaceAll(&quot;  &quot;,&quot;    &quot;) : &quot;this&quot; : &quot;null&quot;) + System.getProperties().getProperty(&quot;line.separator&quot;) +</span>
<span class="nc bnc" id="L412" title="All 4 branches missed.">            &quot;  &quot; + &quot;startAt&quot; + &quot;=&quot; + (getStartAt() != null ? !getStartAt().equals(this)  ? getStartAt().toString().replaceAll(&quot;  &quot;,&quot;    &quot;) : &quot;this&quot; : &quot;null&quot;) + System.getProperties().getProperty(&quot;line.separator&quot;) +</span>
<span class="nc bnc" id="L413" title="All 4 branches missed.">            &quot;  &quot; + &quot;nextBillingAt&quot; + &quot;=&quot; + (getNextBillingAt() != null ? !getNextBillingAt().equals(this)  ? getNextBillingAt().toString().replaceAll(&quot;  &quot;,&quot;    &quot;) : &quot;this&quot; : &quot;null&quot;);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>